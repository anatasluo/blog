<!DOCTYPE html><html lang="zh"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"><meta name="keywords" content="Hexo Theme Keep"><meta name="description" content="Hexo Theme Keep"><meta name="author" content="ANATAS LUO"><title>Weak Symbol in C/C++ | Anatas Luo&#39;s Blog</title><link rel="stylesheet" href="/css/style.css"><link rel="shortcut icon" href="/images/favicon.ico"><link rel="stylesheet" href="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.4.2/source/css/font-awesome.min.css"><script id="hexo-configurations">let KEEP=window.KEEP||{};KEEP.hexo_config={hostname:"anatasluo.github.io",root:"/",language:"zh",path:"search.json"},KEEP.theme_config={toc:{enable:!0,number:"enable",expand_all:!1,init_open:!1},style:{primary_color:"#0066CC",avatar:"/images/avatar.png",favicon:"/images/favicon.ico",article_img_align:"left",left_side_width:"260px",content_max_width:"920px",hover:{shadow:!0,scale:!0},first_screen:{enable:!0,background_img:null,description:"六朝何事 只成门户私计"},scroll:{progress_bar:{enable:!0},percent:{enable:!1}}},local_search:{enable:!0,preload:!0},code_copy:{enable:"enable",style:"default"},pjax:{enable:!0},lazyload:{enable:!1},version:"3.4.2"},KEEP.language_ago={second:"%s seconds ago",minute:"%s minutes ago",hour:"%s hours ago",day:"%s days ago",week:"%s weeks ago",month:"%s months ago",year:"%s years ago"}</script><meta name="generator" content="Hexo 5.4.0"></head><body><div class="progress-bar-container"><span class="scroll-progress-bar"></span> <span class="pjax-progress-bar"></span> <span class="pjax-progress-icon"><i class="fas fa-circle-notch fa-spin"></i></span></div><main class="page-container"><div class="page-main-content"><div class="page-main-content-top"><header class="header-wrapper"><div class="header-content"><div class="left"><a class="logo-title" href="/">Anatas Luo&#39;s Blog</a></div><div class="right"><div class="pc"><ul class="menu-list"><li class="menu-item"><a href="/">首页</a></li><li class="menu-item"><a href="/archives">归档</a></li><li class="menu-item"><a href="/about">关于</a></li><li class="menu-item search search-popup-trigger"><i class="fas fa-search"></i></li></ul></div><div class="mobile"><div class="icon-item search search-popup-trigger"><i class="fas fa-search"></i></div><div class="icon-item menu-bar"><div class="menu-bar-middle"></div></div></div></div></div><div class="header-drawer"><ul class="drawer-menu-list"><li class="drawer-menu-item flex-center"><a href="/">首页</a></li><li class="drawer-menu-item flex-center"><a href="/archives">归档</a></li><li class="drawer-menu-item flex-center"><a href="/about">关于</a></li></ul></div><div class="window-mask"></div></header></div><div class="page-main-content-middle"><div class="main-content"><div class="fade-in-down-animation"><div class="article-content-container"><div class="article-title"><span class="title-hover-animation">Weak Symbol in C/C++</span></div><div class="article-header"><div class="avatar"><img src="/images/avatar.png"></div><div class="info"><div class="author"><span class="name">ANATAS LUO</span> <span class="author-label">苏拉</span></div><div class="meta-info"><div class="article-meta-info"><span class="article-date article-meta-item"><i class="fas fa-edit"></i>&nbsp;2020-06-22 14:46:53 </span><span class="article-tags article-meta-item"><i class="fas fa-tags"></i>&nbsp;<ul><li><a href="/tags/C/">C</a>&nbsp;</li><li>| <a href="/tags/C/">C++</a>&nbsp;</li><li>| <a href="/tags/GCC/">GCC</a>&nbsp;</li></ul></span><span class="article-wordcount article-meta-item"><i class="fas fa-file-word"></i>&nbsp;<span>856 字</span></span></div></div></div></div><div class="article-content markdown-body"><h2 id="weak-symbol"><a href="#weak-symbol" class="headerlink" title="weak symbol"></a>weak symbol</h2><p><em>weak symbol</em>是二进制文件里的一种符号类型，与之相对的，是<em>strong symbol</em>。符号的类型跟代码中的声明和实现有关，查看以下代码：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">#include &lt;cstdio&gt;</span><br><span class="line"></span><br><span class="line"># define weak_alias(name, aliasname) _weak_alias (name, aliasname)</span><br><span class="line"># define _weak_alias(name, aliasname) \</span><br><span class="line">  extern __typeof (name) aliasname __attribute__ ((weak, alias (#name)));</span><br><span class="line"></span><br><span class="line">extern &quot;C&quot; &#123;</span><br><span class="line">    extern void UndefinedSymbol();</span><br><span class="line"></span><br><span class="line">    void StrongSymbol()</span><br><span class="line">    &#123;</span><br><span class="line">        printf(&quot;Strong Symbol \n&quot;);</span><br><span class="line">        return;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    weak_alias(StrongSymbol, WeakAliasSymbol);</span><br><span class="line"></span><br><span class="line">    int g_1;</span><br><span class="line">    int g_2 &#x3D; 1;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">int main() &#123;</span><br><span class="line">    StrongSymbol();</span><br><span class="line">    WeakAliasSymbol();</span><br><span class="line">    UndefinedSymbol();</span><br><span class="line">    return 0;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>通过以下命令得到对应的符号类型</p><blockquote><p>g++ -c main.cpp<br>nm main.o</p></blockquote><p>得到的输出为</p><blockquote><p>B g_1<br>D g_2<br>T StrongSymbol<br>U UndefinedSymbol<br>W WeakAliasSymbol</p></blockquote><p>基本涵盖了常见的符号类型:</p><ol><li>g_1 -&gt; B 表示未初始化或初始化为0的符号，存储在BSS段</li><li>g_2 -&gt; D 表示初始化的符号，存储在DATA段</li><li>StrongSymbol -&gt; T 表示既有声明，也有定义的函数，存储在TEXT段</li><li>UndefinedSymbol -&gt; U 该函数仅有声明，没有定义，具体的定义推迟到链接阶段出现</li><li>WeakAliasSymbol -&gt; W 该函数有声明，也可能存在定义，但是属于弱符号</li></ol><h2 id="一般用法"><a href="#一般用法" class="headerlink" title="一般用法"></a>一般用法</h2><p>如果在一个二进制文件中，出现两个类型均为T的同名符号，就会出现”Mutiple definition”的错误。但是如果如果一个类型为W的弱符号跟一个类型为T的强符号同时出现，那么定义便由类型为T的强符号决定，这也是弱符号(weak symbol)的一般用途，即允许使用该库的开发者自定义相关实现，但同时也提供了一个默认实现。关于这一用法，可以参考<a class="link" target="_blank" rel="noopener" href="http://www.vishalchovatiya.com/default-handlers-in-c-weak_alias/">这里<i class="fas fa-external-link-alt"></i></a></p><p>更多的符号类型，参考<a class="link" target="_blank" rel="noopener" href="https://sourceware.org/binutils/docs/binutils/nm.html">GNU文档<i class="fas fa-external-link-alt"></i></a></p><h2 id="更本质的原则"><a href="#更本质的原则" class="headerlink" title="更本质的原则"></a>更本质的原则</h2><p>考虑以下情形：</p><ol><li>二进制文件中调用了某个外部接口UndefinedSymbol</li><li>动态链接库libt1中声明了UndefinedSymbol为一个类型为T的StrongAlias符号的weak alias</li><li>动态链接库libt2中声明了UndefinedSymbol为一个类型为T的符号，即给出了具体的定义</li><li>二进制同时链接了libt1和libt2</li></ol><p>问题是，二进制会链接哪一个库中的UndefinedSymbol？<br>答案是，取决于链接的顺序。</p><p>关于这一符号解析原则的阐述，在以下的两份文档中给出了说明(见参考2和3)：</p><p>关于符号解析的规则</p><blockquote><p>Another form of simple symbol resolution, interposition, occurs between relocatable objects and shared objects, or between multiple shared objects. In these cases, when a symbol is multiply-defined, the relocatable object, or the first definition between multiple shared objects, is silently taken by the link-editor. The relocatable object’s definition, or the first shared object’s definition, is said to interpose on all other definitions. This interposition can be used to override the functionality provided by another shared object. Multiply-defined symbols that occur between relocatable objects and shared objects, or between multiple shared objects, are treated identically. A symbols weak binding or global binding is irrelevant. By resolving to the first definition, regardless of the symbols binding, both the link-editor and runtime linker behave consistently.</p></blockquote><p>关于链接顺序的说明</p><blockquote><p>Search the library named library when linking. (The second alternative with the library as a separate argument is only for POSIX compliance and is not recommended.) It makes a difference where in the command you write this option; the linker searches and processes libraries and object files in the order they are specified. Thus, <code>foo.o -lz bar.o&#39; searches library</code>z’ after file foo.o but before bar.o. If bar.o refers to functions in `z’, those functions may not be loaded. The linker searches a standard list of directories for the library, which is actually a file named liblibrary.a. The linker then uses this file as if it had been specified precisely by name.</p></blockquote><p>简单的来说，就是以最先链接到的为准。</p><h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><ol><li><a class="link" target="_blank" rel="noopener" href="https://leondong1993.github.io/2017/04/strong-weak-symbol/">strong weak symbol<i class="fas fa-external-link-alt"></i></a></li><li><a class="link" target="_blank" rel="noopener" href="https://docs.oracle.com/cd/E19120-01/open.solaris/819-0690/chapter2-93321/index.html">Oracle Symbol Resolution<i class="fas fa-external-link-alt"></i></a></li><li><a class="link" target="_blank" rel="noopener" href="https://gcc.gnu.org/onlinedocs/gcc-4.1.2/gcc/Link-Options.html">GNU Link Options<i class="fas fa-external-link-alt"></i></a></li></ol></div><div class="post-copyright-info"><div class="article-copyright-info-container"><ul><li>本文标题：Weak Symbol in C/C++</li><li>本文作者：ANATAS LUO</li><li>创建时间：2020-06-22 14:46:53</li><li>本文链接：https://anatasluo.github.io/2020/06/22/Weak-Symbol-in-C-C++/</li><li>版权声明：本博客所有文章除特别声明外，均采用 <a class="license" target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh">BY-NC-SA</a> 许可协议。转载请注明出处！</li></ul></div></div><div class="article-nav"><div class="article-prev"><a class="prev" rel="prev" href="/2020/06/25/C-C-%E4%B8%AD%E7%9A%84%E5%86%85%E5%AD%98%E6%B3%84%E9%9C%B2%E6%A3%80%E6%B5%8B/"><span class="left arrow-icon flex-center"><i class="fas fa-chevron-left"></i> </span><span class="title flex-center"><span class="post-nav-title-item">C/C++中的内存泄露检测</span> <span class="post-nav-item">上一篇</span></span></a></div><div class="article-next"><a class="next" rel="next" href="/2020/06/15/C-C-%E4%BB%A3%E7%A0%81%E6%89%A9%E5%BC%A0/"><span class="title flex-center"><span class="post-nav-title-item">C/C++代码扩张</span> <span class="post-nav-item">下一篇</span> </span><span class="right arrow-icon flex-center"><i class="fas fa-chevron-right"></i></span></a></div></div></div></div></div></div><div class="page-main-content-bottom"><footer class="footer"><div class="info-container"><div class="copyright-info info-item">&copy; <span>2020</span>&nbsp;-&nbsp; 2021&nbsp;<i class="fas fa-heart icon-animate"></i>&nbsp;<a href="/">ANATAS LUO</a></div><div class="theme-info info-item">由 <a target="_blank" href="https://hexo.io">Hexo</a> 驱动&nbsp;|&nbsp;主题&nbsp;<a class="theme-version" target="_blank" href="https://github.com/XPoet/hexo-theme-keep">Keep v3.4.2</a></div></div></footer></div></div><div class="post-tools"><div class="post-tools-container"><ul class="tools-list"><li class="tools-item page-aside-toggle"><i class="fas fa-outdent"></i></li></ul></div></div><div class="right-bottom-side-tools"><div class="side-tools-container"><ul class="side-tools-list"><li class="tools-item tool-font-adjust-plus flex-center"><i class="fas fa-search-plus"></i></li><li class="tools-item tool-font-adjust-minus flex-center"><i class="fas fa-search-minus"></i></li><li class="tools-item tool-expand-width flex-center"><i class="fas fa-arrows-alt-h"></i></li><li class="tools-item tool-dark-light-toggle flex-center"><i class="fas fa-moon"></i></li><li class="tools-item tool-scroll-to-top flex-center"><i class="fas fa-arrow-up"></i></li><li class="tools-item tool-scroll-to-bottom flex-center"><i class="fas fa-arrow-down"></i></li></ul><ul class="exposed-tools-list"><li class="tools-item tool-toggle-show flex-center"><i class="fas fa-cog fa-spin"></i></li></ul></div></div><aside class="page-aside"><div class="post-toc-wrap"><div class="post-toc"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#weak-symbol"><span class="nav-number">1.</span> <span class="nav-text">weak symbol</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%B8%80%E8%88%AC%E7%94%A8%E6%B3%95"><span class="nav-number">2.</span> <span class="nav-text">一般用法</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%9B%B4%E6%9C%AC%E8%B4%A8%E7%9A%84%E5%8E%9F%E5%88%99"><span class="nav-number">3.</span> <span class="nav-text">更本质的原则</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%8F%82%E8%80%83"><span class="nav-number">4.</span> <span class="nav-text">参考</span></a></li></ol></div></div></aside><div class="image-viewer-container"><img src=""></div><div class="search-pop-overlay"><div class="popup search-popup"><div class="search-header"><span class="search-input-field-pre"><i class="fas fa-keyboard"></i></span><div class="search-input-container"><input autocomplete="off" autocorrect="off" autocapitalize="off" placeholder="搜索..." spellcheck="false" type="search" class="search-input"></div><span class="popup-btn-close"><i class="fas fa-times"></i></span></div><div id="search-result"><div id="no-result"><i class="fas fa-spinner fa-pulse fa-5x fa-fw"></i></div></div></div></div></main><script src="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.4.2/source/js/utils.js"></script><script src="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.4.2/source/js/main.js"></script><script src="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.4.2/source/js/header-shrink.js"></script><script src="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.4.2/source/js/back2top.js"></script><script src="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.4.2/source/js/dark-light-toggle.js"></script><script src="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.4.2/source/js/local-search.js"></script><script src="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.4.2/source/js/code-copy.js"></script><div class="post-scripts pjax"><script src="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.4.2/source/js/left-side-toggle.js"></script><script src="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.4.2/source/js/libs/anime.min.js"></script><script src="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.4.2/source/js/toc.js"></script></div><script src="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.4.2/source/js/libs/pjax.min.js"></script><script>window.addEventListener("DOMContentLoaded",()=>{const e=new Pjax({selectors:["head title",".page-container",".pjax"],history:!0,debug:!1,cacheBust:!1,timeout:0,analytics:!1,currentUrlFullReload:!1,scrollRestoration:!1});document.addEventListener("pjax:send",()=>{KEEP.utils.pjaxProgressBarStart()}),document.addEventListener("pjax:complete",()=>{KEEP.utils.pjaxProgressBarEnd(),e.executeScripts(document.querySelectorAll("script[data-pjax], .pjax script")),KEEP.refresh()})})</script></body></html>